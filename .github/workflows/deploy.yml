name: ë ë©”ì´íŠ¸ ë°°í¬

on:
  push:
    branches:
      - master
  workflow_dispatch:
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  test:
    name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    runs-on: ubuntu-latest
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: pnpm ì„¤ì •
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile

      - name: íƒ€ì… ì²´í¬
        run: pnpm run type-check

      - name: ë¦°íŠ¸ ì²´í¬
        run: pnpm run lint --max-warnings=0 || true

      - name: ë¹Œë“œ í…ŒìŠ¤íŠ¸
        run: pnpm run build

  build-and-deploy:
    name: ë¹Œë“œ ë° ë°°í¬
    runs-on: ubuntu-latest
    needs: test
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')

    env:
      NEXT_PUBLIC_KAKAO_KEY: ${{ secrets.NEXT_PUBLIC_KAKAO_KEY }}
      NEXT_PUBLIC_GOOGLE_ADSENSE_ID: ${{ secrets.NEXT_PUBLIC_GOOGLE_ADSENSE_ID }}
      NEXT_PUBLIC_GA_MEASUREMENT_ID: ${{ secrets.NEXT_PUBLIC_GA_MEASUREMENT_ID }}
      NEXT_PUBLIC_SITE_URL: ${{ secrets.NEXT_PUBLIC_SITE_URL }}

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: pnpm ì„¤ì •
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile

      - name: Next.js ë¹Œë“œ
        run: pnpm run build

      - name: ë¹Œë“œ íŒŒì¼ íŒ¨í‚¤ì§•
        run: |
          # í•„ìš”í•œ íŒŒì¼ë§Œ íŒ¨í‚¤ì§•í•˜ì—¬ ì—…ë¡œë“œ ì†ë„ í–¥ìƒ
          tar -czf ttimate-build.tar.gz \
            .next \
            public \
            package.json \
            pnpm-lock.yaml \
            next.config.ts \
            --exclude='.next/cache' \
            --exclude='node_modules'

      - name: SSH í‚¤ ì„¤ì •
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > private_key.pem
          chmod 600 private_key.pem

      - name: EC2 ì„œë²„ ì¤€ë¹„
        run: |
          ssh -o StrictHostKeyChecking=no -i private_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            # ì• í”Œë¦¬ì¼€ì´ì…˜ ë””ë ‰í† ë¦¬ ìƒì„±
            sudo mkdir -p /var/www/ttimate
            sudo chown -R $USER:$USER /var/www/ttimate
            
            # ë°±ì—… ë””ë ‰í† ë¦¬ ìƒì„±
            mkdir -p /var/www/ttimate/backup
            
            # í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì•± ë°±ì—… (rollbackìš©)
            if [ -d "/var/www/ttimate/current" ]; then
              cp -r /var/www/ttimate/current /var/www/ttimate/backup/$(date +%Y%m%d_%H%M%S)
              # ì˜¤ë˜ëœ ë°±ì—… ì •ë¦¬ (ìµœê·¼ 5ê°œë§Œ ìœ ì§€)
              ls -t /var/www/ttimate/backup/ | tail -n +6 | xargs -r rm -rf
            fi
          EOF

      - name: ë¹Œë“œ íŒŒì¼ ì—…ë¡œë“œ
        run: |
          scp -i private_key.pem -o StrictHostKeyChecking=no ttimate-build.tar.gz ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/var/www/ttimate/

      - name: EC2ì—ì„œ ë°°í¬ ì‹¤í–‰
        run: |
          ssh -o StrictHostKeyChecking=no -i private_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            cd /var/www/ttimate
            
            # ìƒˆ ë²„ì „ ë””ë ‰í† ë¦¬ ìƒì„±
            rm -rf new_version
            mkdir new_version
            
            # ë¹Œë“œ íŒŒì¼ ì••ì¶• í•´ì œ
            tar -xzf ttimate-build.tar.gz -C new_version/
            rm ttimate-build.tar.gz
            
            # Node.js í™˜ê²½ ì„¤ì •
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            nvm use 20 || nvm install 20
            
            # pnpm ì„¤ì •
            corepack enable
            corepack prepare pnpm@9 --activate
            export PNPM_HOME="$HOME/.local/share/pnpm"
            export PATH="$PNPM_HOME:$PATH"
            
            # ìƒˆ ë²„ì „ì— ì˜ì¡´ì„± ì„¤ì¹˜ (ìš´ì˜ìš©ë§Œ)
            cd new_version
            pnpm install --prod --frozen-lockfile
            
            # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„±
            cat > .env.local << 'ENVEOF'
            NEXT_PUBLIC_KAKAO_KEY=${{ secrets.NEXT_PUBLIC_KAKAO_KEY }}
            NEXT_PUBLIC_GOOGLE_ADSENSE_ID=${{ secrets.NEXT_PUBLIC_GOOGLE_ADSENSE_ID }}
            NEXT_PUBLIC_GA_MEASUREMENT_ID=${{ secrets.NEXT_PUBLIC_GA_MEASUREMENT_ID }}
            NEXT_PUBLIC_SITE_URL=${{ secrets.NEXT_PUBLIC_SITE_URL }}
            NODE_ENV=production
            PORT=3001
            ENVEOF
            
            cd /var/www/ttimate
            
            # PM2ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ê´€ë¦¬
            pm2 delete ttimate 2>/dev/null || true
            
            # ì‹¬ë³¼ë¦­ ë§í¬ ì—…ë°ì´íŠ¸ (ë¬´ì¤‘ë‹¨ ë°°í¬)
            rm -rf current
            mv new_version current
            
            # PM2ë¡œ ìƒˆ ë²„ì „ ì‹œì‘
            cd current
            pm2 start pnpm --name "ttimate" -- start
            pm2 save
            
            # Nginx ì„¤ì • í™•ì¸ ë° ì¬ë¡œë“œ (í•„ìš”ì‹œ)
            sudo nginx -t && sudo systemctl reload nginx || echo "Nginx reload skipped"
            
            echo "ğŸš€ ë ë©”ì´íŠ¸ ë°°í¬ ì™„ë£Œ!"
            echo "ì„œë²„ ìƒíƒœ:"
            pm2 list
          EOF

      - name: ë°°í¬ ìƒíƒœ í™•ì¸
        run: |
          ssh -o StrictHostKeyChecking=no -i private_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            # í—¬ìŠ¤ì²´í¬
            sleep 10
            if curl -f http://localhost:3001 > /dev/null 2>&1; then
              echo "âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤."
            else
              echo "âŒ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤."
              pm2 logs ttimate --lines 50
              exit 1
            fi
          EOF

      - name: ë°°í¬ ì™„ë£Œ ì•Œë¦¼
        if: success()
        run: |
          echo "ğŸ‰ ë ë©”ì´íŠ¸ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ì‚¬ì´íŠ¸: ${{ secrets.NEXT_PUBLIC_SITE_URL }}"
          echo "ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')"

      - name: ë°°í¬ ì‹¤íŒ¨ ì‹œ ë¡¤ë°±
        if: failure()
        run: |
          ssh -o StrictHostKeyChecking=no -i private_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            cd /var/www/ttimate
            echo "âŒ ë°°í¬ ì‹¤íŒ¨! ì´ì „ ë²„ì „ìœ¼ë¡œ ë¡¤ë°±í•©ë‹ˆë‹¤..."
            
            # ê°€ì¥ ìµœê·¼ ë°±ì—…ìœ¼ë¡œ ë¡¤ë°±
            LATEST_BACKUP=$(ls -t backup/ | head -n 1)
            if [ -n "$LATEST_BACKUP" ]; then
              pm2 delete ttimate 2>/dev/null || true
              rm -rf current
              cp -r backup/$LATEST_BACKUP current
              cd current
              pm2 start pnpm --name "ttimate" -- start
              pm2 save
              echo "âœ… ë¡¤ë°± ì™„ë£Œ: $LATEST_BACKUP"
            else
              echo "âŒ ë¡¤ë°±í•  ë°±ì—…ì´ ì—†ìŠµë‹ˆë‹¤."
            fi
          EOF

      - name: ì •ë¦¬
        if: always()
        run: |
          rm -f private_key.pem ttimate-build.tar.gz