name: ë ë©”ì´íŠ¸ ë°°í¬

on:
  push:
    branches:
      - master
  workflow_dispatch:
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  test:
    name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    runs-on: ubuntu-latest
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: pnpm ì„¤ì •
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile

      - name: íƒ€ì… ì²´í¬
        run: pnpm run type-check

      - name: ë¦°íŠ¸ ì²´í¬
        run: pnpm run lint --max-warnings=0 || true

      - name: ë¹Œë“œ í…ŒìŠ¤íŠ¸
        run: pnpm run build

  build-and-deploy:
    name: ë¹Œë“œ ë° ë°°í¬
    runs-on: ubuntu-latest
    needs: test
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')

    env:
      NEXT_PUBLIC_KAKAO_KEY: ${{ secrets.NEXT_PUBLIC_KAKAO_KEY }}
      NEXT_PUBLIC_GOOGLE_ADSENSE_ID: ${{ secrets.NEXT_PUBLIC_GOOGLE_ADSENSE_ID }}
      NEXT_PUBLIC_GA_MEASUREMENT_ID: ${{ secrets.NEXT_PUBLIC_GA_MEASUREMENT_ID }}
      NEXT_PUBLIC_SITE_URL: ${{ secrets.NEXT_PUBLIC_SITE_URL }}

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: pnpm ì„¤ì •
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile

      - name: Next.js ë¹Œë“œ
        run: pnpm run build

      - name: ë¹Œë“œ íŒŒì¼ íŒ¨í‚¤ì§•
        run: |
          # í•„ìš”í•œ íŒŒì¼ë§Œ íŒ¨í‚¤ì§•í•˜ì—¬ ì—…ë¡œë“œ ì†ë„ í–¥ìƒ
          echo "ğŸ“¦ íŒ¨í‚¤ì§•í•  íŒŒì¼ í™•ì¸..."
          ls -la package.json pnpm-lock.yaml next.config.ts
          ls -la .next/ public/

          echo "ğŸ“„ package.json ë‚´ìš© ê²€ì¦:"
          echo "íŒŒì¼ í¬ê¸°: $(wc -c < package.json) bytes"
          head -3 package.json

          tar -czf ttimate-build.tar.gz \
            --exclude='.next/cache' \
            --exclude='node_modules' \
            .next \
            public \
            package.json \
            pnpm-lock.yaml \
            next.config.ts

          echo "âœ… íŒ¨í‚¤ì§• ì™„ë£Œ - íŒŒì¼ í¬ê¸°: $(du -h ttimate-build.tar.gz | cut -f1)"

          echo "ğŸ“¦ ì••ì¶• íŒŒì¼ ë‚´ìš© ê²€ì¦:"
          tar -tzf ttimate-build.tar.gz | grep -E "(package\.json|pnpm-lock\.yaml)" || echo "âš ï¸ í•„ìˆ˜ íŒŒì¼ì´ ì••ì¶•ì— í¬í•¨ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"

      - name: SSH í‚¤ ì„¤ì •
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | base64 --decode > private_key.pem
          chmod 600 private_key.pem

      - name: EC2 ì„œë²„ ì¤€ë¹„
        run: |
          ssh -o StrictHostKeyChecking=no -i private_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            # ë””ìŠ¤í¬ ê³µê°„ í™•ì¸
            echo "ğŸ’¾ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ í™•ì¸:"
            df -h /var/www/ || df -h /
            
            # ì• í”Œë¦¬ì¼€ì´ì…˜ ë””ë ‰í† ë¦¬ ìƒì„±
            sudo mkdir -p /var/www/ttimate
            sudo chown -R $USER:$USER /var/www/ttimate
            
            # ê¶Œí•œ í™•ì¸
            echo "ğŸ”’ ë””ë ‰í† ë¦¬ ê¶Œí•œ í™•ì¸:"
            ls -ld /var/www/ttimate
            
            # ë°±ì—… ë””ë ‰í† ë¦¬ ìƒì„±
            mkdir -p /var/www/ttimate/backup
            
            # ì„ì‹œ íŒŒì¼ ì •ë¦¬ (ê³µê°„ í™•ë³´)
            echo "ğŸ§¹ ì„ì‹œ íŒŒì¼ ì •ë¦¬..."
            rm -f /var/www/ttimate/*.tar.gz
            rm -rf /var/www/ttimate/new_version
            
            # í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì•± ë°±ì—… (rollbackìš©)
            if [ -d "/var/www/ttimate/current" ]; then
              cp -r /var/www/ttimate/current /var/www/ttimate/backup/$(date +%Y%m%d_%H%M%S)
              # ì˜¤ë˜ëœ ë°±ì—… ì •ë¦¬ (ìµœê·¼ 3ê°œë§Œ ìœ ì§€ - ê³µê°„ ì ˆì•½)
              ls -t /var/www/ttimate/backup/ | tail -n +4 | xargs -r rm -rf
            fi
            
            # ì •ë¦¬ í›„ ë””ìŠ¤í¬ ê³µê°„ ì¬í™•ì¸
            echo "ğŸ’¾ ì •ë¦¬ í›„ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰:"
            df -h /var/www/ || df -h /
          EOF

      - name: ë¹Œë“œ íŒŒì¼ ì—…ë¡œë“œ
        run: |
          echo "ğŸ“¤ ë¹Œë“œ íŒŒì¼ ì—…ë¡œë“œ ì¤‘..."
          echo "íŒŒì¼ í¬ê¸°: $(du -h ttimate-build.tar.gz | cut -f1)"

          # ì¬ì‹œë„ ë¡œì§ì„ í¬í•¨í•œ SCP ì—…ë¡œë“œ
          max_attempts=3
          attempt=1

          while [ $attempt -le $max_attempts ]; do
            echo "ì—…ë¡œë“œ ì‹œë„ $attempt/$max_attempts"
            
            if scp -v -i private_key.pem -o StrictHostKeyChecking=no ttimate-build.tar.gz ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/var/www/ttimate/; then
              echo "âœ… ì—…ë¡œë“œ ì„±ê³µ!"
              break
            else
              echo "âŒ ì—…ë¡œë“œ ì‹¤íŒ¨ (ì‹œë„ $attempt/$max_attempts)"
              if [ $attempt -eq $max_attempts ]; then
                echo "ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ë„ë‹¬. ì—…ë¡œë“œ ì‹¤íŒ¨."
                exit 1
              fi
              echo "5ì´ˆ í›„ ì¬ì‹œë„..."
              sleep 5
              attempt=$((attempt + 1))
            fi
          done

      - name: EC2ì—ì„œ ë°°í¬ ì‹¤í–‰
        run: |
          ssh -o StrictHostKeyChecking=no -i private_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            cd /var/www/ttimate
            
            # ìƒˆ ë²„ì „ ë””ë ‰í† ë¦¬ ìƒì„±
            rm -rf new_version
            mkdir new_version
            
            # ë¹Œë“œ íŒŒì¼ ì••ì¶• í•´ì œ
            echo "ğŸ“¦ ì••ì¶• íŒŒì¼ ë‚´ìš© í™•ì¸:"
            tar -tzf ttimate-build.tar.gz | head -10
            
            echo "ğŸ“‚ ì••ì¶• í•´ì œ ì¤‘..."
            tar -xzf ttimate-build.tar.gz -C new_version/
            
            echo "ğŸ“‹ ì••ì¶• í•´ì œ í›„ íŒŒì¼ í™•ì¸:"
            ls -la new_version/
            
            echo "ğŸ“„ package.json ë‚´ìš© í™•ì¸:"
            if [ -f "new_version/package.json" ]; then
              echo "package.json íŒŒì¼ í¬ê¸°: $(wc -c < new_version/package.json) bytes"
              head -5 new_version/package.json
            else
              echo "âŒ package.json íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!"
              exit 1
            fi
            
            rm ttimate-build.tar.gz
            
            # Node.js í™˜ê²½ ì„¤ì •
            echo "ğŸ”§ Node.js í™˜ê²½ ì„¤ì • ì¤‘..."
            export NVM_DIR="$HOME/.nvm"
            
            # NVM ë¡œë“œ
            if [ -s "$NVM_DIR/nvm.sh" ]; then
              \. "$NVM_DIR/nvm.sh"
              echo "âœ… NVM ë¡œë“œ ì™„ë£Œ"
            else
              echo "âš ï¸ NVMì´ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì‹œìŠ¤í…œ Node.js ì‚¬ìš©"
            fi
            
            # Node.js ë²„ì „ í™•ì¸/ì„¤ì¹˜
            if command -v nvm > /dev/null 2>&1; then
              nvm use 20 2>/dev/null || nvm install 20
            fi
            
            # Node.js í™•ì¸
            node --version || echo "âŒ Node.jsë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            
            # pnpm ì„¤ì • (ê¶Œí•œ ì˜¤ë¥˜ ë°©ì§€)
            echo "ğŸ”§ pnpm í™˜ê²½ ì„¤ì • ì¤‘..."
            if command -v corepack > /dev/null 2>&1; then
              corepack enable 2>/dev/null || echo "âš ï¸ corepack enable ì‹¤íŒ¨ (ê¶Œí•œ ë¬¸ì œ)"
              corepack prepare pnpm@9 --activate 2>/dev/null || echo "âš ï¸ corepack prepare ì‹¤íŒ¨"
            fi
            
            # pnpm ê²½ë¡œ ì„¤ì •
            export PNPM_HOME="$HOME/.local/share/pnpm"
            export PATH="$PNPM_HOME:$PATH"
            
            # pnpm ë²„ì „ í™•ì¸
            pnpm --version || echo "âŒ pnpmì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            
            # ìƒˆ ë²„ì „ì— ì˜ì¡´ì„± ì„¤ì¹˜ (ìš´ì˜ìš©ë§Œ)
            cd new_version
            
            # package.json ì¡´ì¬ ë° ë‚´ìš© í™•ì¸
            if [ ! -f "package.json" ]; then
              echo "âŒ package.json íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!"
              ls -la
              exit 1
            fi
            
            # package.json íŒŒì¼ì´ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
            if [ ! -s "package.json" ]; then
              echo "âŒ package.json íŒŒì¼ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!"
              echo "íŒŒì¼ í¬ê¸°: $(wc -c < package.json) bytes"
              ls -la package.json
              exit 1
            fi
            
            # JSON ìœ íš¨ì„± ê²€ì‚¬
            if ! node -e "JSON.parse(require('fs').readFileSync('package.json', 'utf8'))" 2>/dev/null; then
              echo "âŒ package.jsonì´ ìœ íš¨í•œ JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤!"
              echo "íŒŒì¼ ë‚´ìš©:"
              cat package.json | head -10
              exit 1
            fi
            
            echo "âœ… package.json ê²€ì¦ ì™„ë£Œ"
            echo "íŒŒì¼ í¬ê¸°: $(wc -c < package.json) bytes"
            
            pnpm install --prod --frozen-lockfile
            
            # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„±
            cat > .env.local << 'ENVEOF'
            NEXT_PUBLIC_KAKAO_KEY=${{ secrets.NEXT_PUBLIC_KAKAO_KEY }}
            NEXT_PUBLIC_GOOGLE_ADSENSE_ID=${{ secrets.NEXT_PUBLIC_GOOGLE_ADSENSE_ID }}
            NEXT_PUBLIC_GA_MEASUREMENT_ID=${{ secrets.NEXT_PUBLIC_GA_MEASUREMENT_ID }}
            NEXT_PUBLIC_SITE_URL=${{ secrets.NEXT_PUBLIC_SITE_URL }}
            NODE_ENV=production
            PORT=3001
            ENVEOF
            
            cd /var/www/ttimate
            
            # PM2ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ê´€ë¦¬
            pm2 delete ttimate 2>/dev/null || true
            
            # ì‹¬ë³¼ë¦­ ë§í¬ ì—…ë°ì´íŠ¸ (ë¬´ì¤‘ë‹¨ ë°°í¬)
            rm -rf current
            mv new_version current
            
            # PM2ë¡œ ìƒˆ ë²„ì „ ì‹œì‘
            cd current
            PORT=3001 pm2 start pnpm --name "ttimate" -- start
            pm2 save
            
            # Nginx ì„¤ì • í™•ì¸ ë° ì¬ë¡œë“œ (í•„ìš”ì‹œ)
            sudo nginx -t && sudo systemctl reload nginx || echo "Nginx reload skipped"
            
            echo "ğŸš€ ë ë©”ì´íŠ¸ ë°°í¬ ì™„ë£Œ!"
            echo "ì„œë²„ ìƒíƒœ:"
            pm2 list
          EOF

      - name: ì •ë¦¬
        if: always()
        run: |
          rm -f private_key.pem ttimate-build.tar.gz
